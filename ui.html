    <div id="root">
  <div class="tabs">
    <div class="tab active" data-step="1">
      <span>1</span> Select Component</div>
    <div class="tab" data-step="2">
      <span>2</span> Add Data</div>
    <div class="tab" data-step="3">
      <span>3</span> Map Fields</div>
  </div>

  <div class="content">
    <!-- Step 1: Component Selection -->
    <div class="step-content active" data-step="1">
      <h2>Select a Component</h2>
      <p class="description">For best results, select a component with text fields and other elements for data population</p>
      
      <div class="instruction-panel" id="selectInstructions">
        <div class="instruction-text">Nothing Selected Yet</div>
      </div>
      
      <div id="componentDetails" class="component-details-panel hidden">
        <div class="selected-component">
          <div class="component-info">
            <svg class="component-icon" width="40" height="40" viewBox="0 0 48 48" fill="none">
              <rect width="48" height="48" fill="white" fill-opacity="0.01"/>
              <path d="M17 12L24 5L31 12L24 19L17 12Z" fill="#EDE5FA" stroke="#cbaaf9" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17 36L24 29L31 36L24 43L17 36Z" fill="#EDE5FA" stroke="#cbaaf9" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M29 24L36 17L43 24L36 31L29 24Z" fill="#EDE5FA" stroke="#cbaaf9" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5 24L12 17L19 24L12 31L5 24Z" fill="#EDE5FA" stroke="#cbaaf9" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="component-details">
              <span class="component-name"></span>
              <span class="variant-count"></span>
            </div>
          </div>
        </div>

        <div class="array-name-config">
          <label for="arrayName">Array Name:</label>
          <input type="text" 
                 id="arrayName" 
                 value="items" 
                 placeholder="e.g., items, cards, data"
                 onchange="updateJsonStructure()"
                 onkeyup="updateJsonStructure()">
        </div>

        <div class="component-structure">
          <h3>Component Structure</h3>
          <table class="data-fields">
            <thead>
              <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <!-- Dynamically populated -->
            </tbody>
          </table>

          <div class="json-preview">
            <h3 class="json-structure-header">JSON Structure</h3>
            <pre><code id="jsonStructure"></code></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Data Input -->
    <div class="step-content" data-step="2">
      <h2>Add Your Data</h2>
      <p class="description">Paste JSON data</p>

      <div class="json-section">
        <div class="json-header">
          <span>JSON Structure</span>
          <button id="copyTemplate" class="copy-button">
            Copy Template
          </button>
        </div>
          <textarea 
            id="jsonData" 
          spellcheck="primary"
          placeholder="Paste JSON Data here..."
          ></textarea>
        </div>
      </div>

    <!-- Step 3: Field Mapping -->
    <div class="step-content" data-step="3">
      <h2>Map Fields</h2>
      <p class="description">Preview how your data will be mapped to component fields</p>
      
      <div class="mapping-preview">
        <table class="mapping-table">
          <thead>
            <tr>
              <th>Component Field</th>
              <th>Sample Data</th>
            </tr>
          </thead>
          <tbody id="mappingPreview">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">
    <button id="prevStep" class="button secondary">Previous</button>
    <button id="nextStep" class="button primary">Next</button>
  </div>
</div>

<style>
  :root {
    /* Colors */
    --figma-color-text: #333333;
    --figma-color-bg: #FFFFFF;
    --figma-color-border: #E5E5E5;
    --figma-color-text-secondary: #666666;
    --figma-color-bg-secondary: #F5F5F5;
    --figma-color-bg-brand: #084d7b;
    --figma-dark-code-background: #211b2a;
    --figma-color-bg-brand-hover: #0D8DE3;
    --figma-color-text-onbrand: #FFFFFF;
    --figma-color-bg-hover: #EAEAEA;
    
    /* Spacing */
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 12px;
    --spacing-lg: 16px;
    
    /* Border Radius */
    --border-radius-sm: 4px;
    --border-radius-md: 6px;
    --border-radius-lg: 8px;
    --border-radius-circle: 50%;
  }

  body {
    margin: 0;
    height: 100vh;
    font-family: 'SF Pro Display', sans-serif;
    color: var(--figma-color-text);
    background: var(--figma-color-bg);
    letter-spacing: -0.01em;
    line-height: 1.4;
  }

  #root {
    display: flex;
    flex-direction: column;
    height: 580px;
    width: 100%;
  }

  .tabs {
    display: flex;
    border-bottom: 1px solid var(--figma-color-border);
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--figma-color-bg);
    align-items: center;
    text-wrap: nowrap;
  }

  .tab {
    padding: 6px 8px;
    font-size: 12px;
    font-weight: 500;
    color: var(--figma-color-text-secondary);
    cursor: pointer;
    border-radius: var(--border-radius-md);
    margin-right: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .tab span {
    width: 20px;
    height: 20px;
    font-size: 12px;
    font-weight: 600;
    background-color: var(--figma-color-bg-secondary);
    color: var(--figma-color-text-secondary);
    border-radius: var(--border-radius-circle);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .tab.active {
    color: var(--figma-color-text-onbrand);
    background-color: var(--figma-color-bg-brand);
  }

  .tab.active span {
    background-color: rgba(255, 255, 255, 0.2);
    color: var(--figma-color-text-onbrand);
  }

  .instruction-text {
    font-size: 16px;
    background-color: rgba(117, 117, 225, 0.2);
    padding: 10px;
    border-radius: 4px;
    color: rgb(78, 29, 78);
    font-weight: 800;
    letter-spacing: -0.03em;
    text-align: center;
  }
 
  .content {
    flex: 1;
    padding: var(--spacing-lg);
    overflow-y: auto;
    background: #FFFFFF;
  }

  .step-content {
    display: none;
  }

  .step-content.active {
    display: block;
    min-height: 200px;
  }

  h2 {
    margin: 0 0 3px;
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: #333333;
  }

  .description {
    margin: 0 0 16px;
    font-size: 14px;
    color: #707070;
  }
 

  .selected-component {
    background: var(--figma-color-bg-brand-tertiary);
    border: 1px solid var(--figma-color-border-brand);
    border-radius: var(--border-radius-md);
    padding: 12px;
    margin-top: 16px;
  }

  .component-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .component-details {
    display: flex;
    flex-direction: column;
  }

  .component-name {
    font-weight: 500;
    font-size: 13px;
  }

  .component-type {
    font-size: 11px;
    color: var(--figma-color-text-secondary);
  }

  .json-section {
    background: var(--figma-color-bg-secondary);
    border-radius: var(--border-radius-lg);
    overflow: hidden;
  }

  .json-header {
    padding: 5px 12px;
    border-bottom: 1px solid var(--figma-color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .json-structure h3{
    color: var(--figma-color-bg-secondary) !important;
  }

  .json-header span{
    font-size: 11px;
    font-weight: 600;
  }

  textarea {
    width: 100%;
    height: 200px;
    padding: 5px;
    background: #FFFFFF;
    border: 1px solid #E5E5E5;
    border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
    color: var(--figma-color-text);
    font-family: 'SF Mono', monospace;
    font-size: 11px;
    resize: vertical;
  }
  textarea:focus {
    background: #ffffee;
  }

  .footer {
    padding: 16px;
    border-top: 1px solid var(--figma-color-border);
    display: flex;
    justify-content: space-between;
    background: var(--figma-color-bg);
  }

  .button {
    padding: 8px 16px;
    border-radius: var(--border-radius-md);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    min-width: 80px;
  }

  .button.primary {
    background: var(--figma-color-bg-brand-tertiary);
    color: var(--figma-color-text-brand);
    border: none;
  }

  .button.primary:hover {
    background: var(--figma-color-bg-tertiary);
  }

  .button.secondary {
    background: var(--figma-color-bg-secondary);
    color: var(--figma-color-text-secondary);
    border: 1px solid var(--figma-color-border);
  }

  .button.secondary:hover {
    background: var(--figma-color-bg-tertiary);
  }

  .hidden {
    display: none;
  }

  .text-button {
    background: none;
    border: none;
    color: var(--figma-color-text-brand);
    font-size: 13px;
    cursor: pointer;
    padding: 4px 8px;
  }

  .text-button:hover {
    background: var(--figma-color-bg-brand-tertiary);
    border-radius: 4px;
  }

  .component-details-panel {
    margin-top: 24px;
  }

  .component-structure {
    margin: 5px 0;
    background-color: #fffdf7;
    border: 1px solid #f2efe8;
    /* padding: 10px; */
    border-radius: 8px;
  }

  .component-structure h3 {
    font-size: 13px;
    font-weight: 600;
    margin: 0 0 12px 0;
    padding: 5px 5px 0px 10px;
  }

  .data-fields {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 12px;
    margin-bottom: 24px;
  }

  .data-fields thead tr {
    background: #F5F5F5;
  }

  .data-fields th {
    text-align: left;
    padding: 8px;
    font-weight: 500;
    color: #666666;
    border-bottom: 1px solid var(--figma-color-border);
  }

  .data-fields td {
    padding: 8px;
    border-bottom: 1px solid var(--figma-color-border);
  }

  .data-fields tr:nth-child(even) td {
    background: var(--figma-color-bg-secondary);
  }

  .variant-count {
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    background: var(--figma-color-bg-tertiary);
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-block;
  }

  .json-preview {
    background: var(--figma-dark-code-background);
    border: 1px solid #E5E5E5;
    border-radius: var(--border-radius-md);
    padding: var(--spacing-md);
  }

  .json-structure-header {
    color: #fff !important;
  }

  .json-preview code {
    font-family: 'SF Mono', monospace;
    font-size: 10px;
    line-height: 140%;
    font-weight: 300;
    color: #7c7c7c;
  }

  .json-key {
    color: #C5A5C5;
    font-weight: 600;
  }

  .json-string {
    color: #98C379;
  }

  .json-number {
    color: #D19A66;
  }

  .component-structure {
    display: grid;
    gap: 24px;
  }

  .component-structure h3 {
    font-size: 13px;
    font-weight: 600;
    margin: 0;
    color: var(--figma-color-text);
  }

  .copy-button {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--figma-color-bg-brand);
    border: 1px solid var(--figma-color-border);
    border-radius: var(--border-radius-md);
    color: var(--figma-color-text-onbrand);
    font-size: 12px;
    cursor: pointer;
  }

  .copy-button:hover {
    background: var(--figma-color-bg-hover);
  }

  .button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .button.primary {
    background: var(--figma-color-bg-brand);
    color: white;
    border: none;
  }

  .button.primary:not(:disabled):hover {
    background: var(--figma-color-bg-brand-hover);
  }

  .mapping-preview {
    background: var(--figma-color-bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: 9px;
  }

  .mapping-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 10px;
  }

  .mapping-table th {
    text-align: left;
    /* padding: 8px 12px; */
    background: var(--figma-color-bg-tertiary);
    color: var(--figma-color-text-secondary);
    font-weight: 500;
  }

  .mapping-table td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--figma-color-border);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100px;
  }

  .mapping-table tr:nth-child(even) {
    background: var(--figma-color-bg);
  }

  .field-name {
    font-weight: 500;
    color: var(--figma-color-text);
  }

  .sample-data {
    font-family: 'SF Mono', monospace;
    font-size: 10px;
    color: var(--figma-color-text-secondary);
  }

  .tab {
    cursor: default;
    opacity: 0.5;
  }

  .tab[data-visited="true"], 
  .tab.active {
    opacity: 1;
    cursor: pointer;
  }

  .tab[data-visited="true"]:hover {
    background: var(--figma-color-bg-hover);
  }

  .tab.active:hover {
    background: var(--figma-color-bg-brand-hover);
  }

  .validation-warning {
    padding: 5px;
    background-color: #D4351C;
    border-top: 1px solid #e7a79d;
    box-shadow: 0 -3px 3px #e7a79d3b;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .warning-icon {
    flex-shrink: 0;
    font-size: 16px;
    color: #fff;
  }

  .warning-message {
    font-size: 11px;
    letter-spacing: -0.02em;
    color: #ffffff92;
  }

  .warning-message > span {
    font-weight: bold;
    color: #fff;
  }

  .hidden {
    display: none;
  }

  .field-checkbox {
    width: 16px;
    height: 16px;
    margin: 0;
    cursor: pointer;
  }

  .array-name-config {
    margin: 12px 0;
    padding: 8px;
    background: var(--figma-color-bg-secondary);
    border-radius: var(--border-radius-md);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .array-name-config label {
    font-size: 12px;
    color: var(--figma-color-text-secondary);
    font-weight: 500;
  }

  .array-name-config input {
    flex: 1;
    padding: 4px 8px;
    border: 1px solid var(--figma-color-border);
    border-radius: var(--border-radius-sm);
    font-size: 12px;
    background: white;
  }

  .array-name-config input:focus {
    border-color: var(--figma-color-bg-brand);
    outline: none;
  }
</style>

<script>
  console.log('Plugin UI loaded');

  let currentStep = 1;
  let selectedComponent = null;

  function canProceedToNextStep() {
    switch (currentStep) {
      case 1:
        return selectedComponent !== null;
      case 2:
        const jsonData = document.getElementById('jsonData').value;
        try {
          JSON.parse(jsonData);
          return true;
        } catch (e) {
          return false;
        }
      case 3:
        return true;
      default:
        return false;
    }
  }

  function updateStepVisibility() {
    // Hide all steps first
    document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
    // Show current step
    const currentContent = document.querySelector(`.step-content[data-step="${currentStep}"]`);
    if (currentContent) currentContent.classList.add('active');
    
    // Update tabs
    document.querySelectorAll('.tab').forEach(tab => {
      const stepNum = parseInt(tab.dataset.step);
      tab.classList.toggle('active', stepNum === currentStep);
      if (stepNum <= currentStep) {
        tab.setAttribute('data-visited', 'true');
      }
    });
    
    // Update buttons
    const prevButton = document.getElementById('prevStep');
    const nextButton = document.getElementById('nextStep');
    
    if (prevButton) prevButton.disabled = currentStep === 1;
    if (nextButton) {
      nextButton.disabled = !canProceedToNextStep();
      nextButton.textContent = currentStep === 3 ? 'Generate' : 'Next';
    }
  }

  function updateUI() {
    updateStepVisibility();
    
    // Update selection state UI
    const selectInstructions = document.getElementById('selectInstructions');
    const componentDetails = document.getElementById('componentDetails');
    
    if (selectedComponent) {
      selectInstructions.classList.add('hidden');
      componentDetails.classList.remove('hidden');
    } else {
      selectInstructions.classList.remove('hidden');
      componentDetails.classList.add('hidden');
    }
  }

  function updateJsonStructure() {
    if (!selectedComponent) return;
    
    const checkedFields = Array.from(document.querySelectorAll('.field-checkbox:checked'))
      .map(cb => ({
        name: cb.dataset.field,
        type: cb.dataset.type,
        parentFrame: cb.dataset.parent
      }));
    
    // Build the structure based on actual fields
    const structure = {};
    const frameGroups = {};
    
    // First pass: Group fields by their parent frames
    checkedFields.forEach(field => {
      if (field.parentFrame && field.parentFrame.includes('WithPoints')) {
        // Extract the fact number from the frame name (e.g., "Fact1WithPoints" -> "1")
        const factNumber = field.parentFrame.match(/Fact(\d+)WithPoints/)[1];
        if (!frameGroups[factNumber]) {
          frameGroups[factNumber] = {};
        }
        
        // Determine if this is a fact or points field
        if (field.name.startsWith('Fact')) {
          frameGroups[factNumber].text = field.type;
        } else if (field.name.startsWith('Points')) {
          frameGroups[factNumber].points = field.type;
        }
      } else {
        // Handle standalone fields (Name, Image, etc.)
        structure[field.name] = field.type;
      }
    });
    
    // Convert frame groups into facts array
    if (Object.keys(frameGroups).length > 0) {
      structure.facts = Object.entries(frameGroups)
        .sort(([a], [b]) => parseInt(a) - parseInt(b)) // Sort by fact number
        .map(([, value]) => value);
    }
    
    // Get the custom array name or use default
    const arrayName = document.getElementById('arrayName').value.trim() || 'items';
    
    // Create the structure with dynamic key
    const jsonStructure = {
      [arrayName]: [structure]
    };
    
    const jsonEl = document.getElementById('jsonStructure');
    if (jsonEl) {
      const jsonString = JSON.stringify(jsonStructure, null, 2);
      const highlightedJson = jsonString.replace(
        /"([^"]+)":/g, '<span class="json-key">$1</span>:'
      ).replace(
        /: "([^"]+)"/g, ': <span class="json-string">$1</span>'
      ).replace(
        /: (\d+)/g, ': <span class="json-number">$1</span>'
      );
      
      jsonEl.innerHTML = highlightedJson;
    }
  }

  // Navigation handlers
  document.getElementById('prevStep').onclick = () => {
    if (currentStep > 1) {
      currentStep--;
      updateUI();
    }
  };

  document.getElementById('nextStep').onclick = () => {
    if (currentStep < 3 && canProceedToNextStep()) {
      currentStep++;
      updateUI();
    } else if (currentStep === 3 && canProceedToNextStep()) {
      // Handle generate
      const jsonData = document.getElementById('jsonData').value;
      try {
        const data = JSON.parse(jsonData);
        parent.postMessage({ 
          pluginMessage: { 
            type: 'hydrate-cards',
            componentKey: selectedComponent.key,
            jsonData: jsonData
          }
        }, '*');
      } catch (e) {
        console.error('Failed to parse JSON:', e);
      }
    }
  };

  // Add the message handler
  window.onmessage = async (event) => {
    const msg = event.data.pluginMessage;
    console.log('Received message:', msg);
    
    switch (msg.type) {
      case 'component-deselected':
        console.log('Component deselected');
        selectedComponent = null;
        document.getElementById('selectInstructions').classList.remove('hidden');
        document.getElementById('componentDetails').classList.add('hidden');
        updateUI();
        break;
        
      case 'component-selected':
        console.log('Component selected:', msg.component);
        selectedComponent = msg.component;
        
        // Update UI elements
        document.getElementById('selectInstructions').classList.add('hidden');
        const detailsPanel = document.getElementById('componentDetails');
        detailsPanel.classList.remove('hidden');
        
        // Update component info
        const nameEl = detailsPanel.querySelector('.component-name');
        const variantEl = detailsPanel.querySelector('.variant-count');
        
        if (nameEl && variantEl) {
          nameEl.textContent = msg.component.name;
          variantEl.textContent = `${msg.component.variants.length} variants`;
        }
        
        // Update fields table
        const tbody = detailsPanel.querySelector('.data-fields tbody');
        if (tbody && msg.component.fields) {
          tbody.innerHTML = msg.component.fields.map(field => `
            <tr>
              <td style="text-align: center;">
                <input type="checkbox" 
                       class="field-checkbox" 
                       data-field="${field.name}"
                       data-type="${field.type}"
                       data-parent="${field.parentFrame || ''}"
                       ${field.name === '+' ? '' : 'checked'}
                       onchange="updateJsonStructure()">
              </td>
              <td>${field.name}</td>
              <td>${field.type}</td>
              <td>${field.description.replace('Current text: ', '').replace(/^"(.+)"$/, '$1')}</td>
            </tr>
          `).join('');
        }
        
        updateJsonStructure();
        updateUI();
        break;
    }
  };

  // Initialize
  updateUI();
</script>
